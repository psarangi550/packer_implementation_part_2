# converting the JSON template into HCL template in packer 

- Below is an example of a basic builder for AWS EBS AMI in the forms of a JSON packer Template


    
    ```json
        {
            "variables": { //defining the vaqriables over here which can be accessed using the user `<variable name>`
                "aws_source_ami": "ami-039a49e70ea773ffc"
            },
            "builders" :[
                { // defining the builders inside the builders list 
                "type": "amazon-ebs" , // defining the type of builders that we are going to create
                "region": "us-east-1", //defining the region out here 
                "source_ami": "{{user `aws_source_ami`}}", // referencing the variable declared as {{ user `<variable name>` }}
                "instance_type": "t2.micro", // defining the instance type that we are going to create
                "ssh_username": "ubuntu", //defining the username while accessing through the ssh connection
                "ssh_pty": "true", // ssh_pty (bool) - If true, a PTY(psudo terminal ) will be requested for the SSH connection. This defaults to false.
                "ami_name": "tmp-{{timestamp}}", // ami_name that wiull be go be get registered
                "tags": { // defining the tags for the images 
                    "Created-by": "Packer",
                    "OS_Version": "Ubuntu",
                    "Release": "Latest"
                }
                }
            ],
            "provisioners": [ // defining the provisioner over here
                {
                "type": "shell", // defining the provisioner as the shell provisioner over here
                "inline": [ // defining the series of command which will be on the image as list vof command  
                    "mkdir ~/src",
                    "cd ~/src",
                    "git clone https://github.com/hashicorp/demo-terraform-101.git",
                    "cp -R ~/src/demo-terraform-101/assets /tmp",
                    "sudo sh /tmp/assets/setup-web.sh"
            ]
            }
        ]
        }
    

    ```

- here we need to run the `packer hcl2_upgrade <JSON file>` command in order to upgrade the `JSON packer template` to `HCL packer template`

- this will create the `HCL template` with the name as `<JSON FILE>.json.pkr.hcl` as the `packer HCL template`


    ```bash
        packer hcl2_upgrade aws-ebs.json
        #creating the HCL template from JSON file 
        # the output will be as below 
        Successfully created aws-ebs.json.pkr.hcl. Exit 0
    
    ```

    ```packer
        packer { # defining the plugin version that we need over here
        required_plugins { # defining the required_plugin version over here
            amazon = {
            source  = "github.com/hashicorp/amazon"
            version = "~> 1"
            }
        }
        }

        variable "aws_source_ami" {
        type    = string
        default = "ami-039a49e70ea773ffc"
        }

        locals { timestamp = regex_replace(timestamp(), "[- TZ:]", "") } # defining the locval variable as timestamp using the regex_replace() function over here

        source "amazon-ebs" "autogenerated_1" { # while converting from JSON to HCL then it will rename the source block to autogenerated_1 over here as in JSON there were nothing call source block
        ami_name      = "tmp-${local.timestamp}"# here the ami_name been pulled in the local variable that been defined out in here 
        instance_type = "t2.micro"
        region        = "us-east-1"
        source_ami    = "${var.aws_source_ami}" # here this source_ami been refered from the variable block that we have defined earlier
        ssh_pty       = true
        ssh_username  = "ubuntu"
        tags = {
            Created-by = "Packer"
            OS_Version = "Ubuntu"
            Release    = "Latest"
        }
        }

        build {
        sources = ["source.amazon-ebs.autogenerated_1"] # here referecing the source block from build block here

        provisioner "shell" { # here we have the provisioners block defined underneath the build block
            inline = ["mkdir ~/src", "cd ~/src", "git clone https://github.com/hashicorp/demo-terraform-101.git", "cp -R ~/src/demo-terraform-101/assets /tmp", "sudo sh /tmp/assets/setup-web.sh"]
        }

        }
    ```



- here we can then `validate the packer template` by using the command as `packer validate <new HCL template over here>`

    ```bash
        packer validate aws-ebs.json.pkr.hcl
        # validating the newly created hcl template over here 
        # the response as below 
        The configuration is valid.

    ```
    
    ```bash
        #installing the plugin using the packer init command as below 
        packer init aws-ebs.json.pkr.hcl
        # installing all the required plugin over here 
        # the output as below 
        Installed plugin github.com/hashicorp/amazon v1.2.8 in "/home/pratik/.config/packer/plugins/github.com/hashicorp/amazon/packer-plugin-amazon_v1.2.8_x5.0_linux_amd64"

    ```

- then we can build the `packer build` using the command as `packer build <new HCL template we created>`

    ```bash
        packer build aws-ebs.pkr.hcl
        # installing packer as below while creating the packer build over here
        amazon-ebs.autogenerated_1: output will be in this color.

        ==> amazon-ebs.autogenerated_1: Prevalidating any provided VPC information
        ==> amazon-ebs.autogenerated_1: Prevalidating AMI Name: tmp-20231214233435
            amazon-ebs.autogenerated_1: Found Image ID: ami-039a49e70ea773ffc
        ==> amazon-ebs.autogenerated_1: Creating temporary keypair: packer_657b910b-6c39-23ce-cfcc-cd4b770c7232
        ==> amazon-ebs.autogenerated_1: Creating temporary security group for this instance: packer_657b9118-315d-1b28-11f1-a645635c4d48
        ==> amazon-ebs.autogenerated_1: Authorizing access to port 22 from [0.0.0.0/0] in the temporary security groups...
        ==> amazon-ebs.autogenerated_1: Launching a source AWS instance...
            amazon-ebs.autogenerated_1: Instance ID: i-013eb8f5346418f6b
        ==> amazon-ebs.autogenerated_1: Waiting for instance (i-013eb8f5346418f6b) to become ready...
        ==> amazon-ebs.autogenerated_1: Using SSH communicator to connect: 44.211.191.12
        ==> amazon-ebs.autogenerated_1: Waiting for SSH to become available...
        ==> amazon-ebs.autogenerated_1: Connected to SSH!
        ==> amazon-ebs.autogenerated_1: Provisioning with shell script: /tmp/packer-shell2767500289
            amazon-ebs.autogenerated_1: Cloning into 'demo-terraform-101'...
            amazon-ebs.autogenerated_1: remote: Enumerating objects: 449, done.
            amazon-ebs.autogenerated_1: remote: Counting objects: 100% (32/32), done.
            amazon-ebs.autogenerated_1: remote: Compressing objects: 100% (31/31), done.
            amazon-ebs.autogenerated_1: remote: Total 449 (delta 0), reused 16 (delta 0), pack-reused 417
            amazon-ebs.autogenerated_1: Receiving objects: 100% (449/449), 4.33 MiB | 0 bytes/s, done.
            amazon-ebs.autogenerated_1: Resolving deltas: 100% (142/142), done.
            amazon-ebs.autogenerated_1: Checking connectivity... done.
            amazon-ebs.autogenerated_1: Created symlink from /etc/systemd/system/multi-user.target.wants/webapp.service to /lib/systemd/system/webapp.service.
        ==> amazon-ebs.autogenerated_1: Stopping the source instance...
            amazon-ebs.autogenerated_1: Stopping instance
        ==> amazon-ebs.autogenerated_1: Waiting for the instance to stop...
        ==> amazon-ebs.autogenerated_1: Creating AMI tmp-20231214233435 from instance i-013eb8f5346418f6b
            amazon-ebs.autogenerated_1: AMI: ami-001cdbe1e3d9d8693
        ==> amazon-ebs.autogenerated_1: Waiting for AMI to become ready...
        ==> amazon-ebs.autogenerated_1: Skipping Enable AMI deprecation...
        ==> amazon-ebs.autogenerated_1: Adding tags to AMI (ami-001cdbe1e3d9d8693)...
        ==> amazon-ebs.autogenerated_1: Tagging snapshot: snap-0629cbc502ab4fbae
        ==> amazon-ebs.autogenerated_1: Creating AMI tags
            amazon-ebs.autogenerated_1: Adding tag: "Created-by": "Packer"
            amazon-ebs.autogenerated_1: Adding tag: "OS_Version": "Ubuntu"
            amazon-ebs.autogenerated_1: Adding tag: "Release": "Latest"
        ==> amazon-ebs.autogenerated_1: Creating snapshot tags
        ==> amazon-ebs.autogenerated_1: Terminating the source AWS instance...
        ==> amazon-ebs.autogenerated_1: Cleaning up any extra volumes...
        ==> amazon-ebs.autogenerated_1: No volumes to clean up, skipping
        ==> amazon-ebs.autogenerated_1: Deleting temporary security group...
        ==> amazon-ebs.autogenerated_1: Deleting temporary keypair...
        Build 'amazon-ebs.autogenerated_1' finished after 4 minutes 47 seconds.

        ==> Wait completed after 4 minutes 47 seconds

        ==> Builds finished. The artifacts of successful builds are:
        --> amazon-ebs.autogenerated_1: AMIs were created:
        us-east-1: ami-001cdbe1e3d9d8693
    
    ```